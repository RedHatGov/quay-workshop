# Lab 5 - Working with images

## Skopeo
Skopeo has a number of advantages over using other "all-in-one" tools like the docker cli. For starters, Skopeo can move images without an intermediary registry or daemon. Meaning, we don't need a local registry running on our host to store an image, re-tag, and push an image to a new registry. Skopeo can copy an image from one registry to the next, without storing anything locally. Additionally, Skopeo can do fancy things like inspect an image remotely, take an exported tar file of a container image and copy it to a remote registry and more. The advantage here is that we don't need access to a local container runtime to achieve these image management operations, which makes Skopeo a great tool for running within a container as we are in this workshop.

The command structure for Skopeo will feel new when in comparison to the docker cli, because of the various transports in which Skopeo can transfer an image, but when compared to a basic linux `cp` (copy) command, it's quite simple. Because of this, we have to tell Skopeo when we're interacting with a docker V2 API registry using the `docker://` transport mechanism. Other options exist if you're interested in reading more here [Skopeo Copy to the Rescue](https://www.redhat.com/en/blog/skopeo-copy-rescue)

The approach is as simple as `skopeo copy <transport>:<source> <transport>:<dest>`. Just like the copy command, it's source on the left and destination on the right.

## Skopeo Login
First, we'll need to log into our registry to be able to write an image to your registry. Quay makes this easy, and will create a timeboxed encrypted password for you to use, so you're not forced to leave your sensitive credentials in a terminals session history.

From the Quay dashboard:
* Click your username dropdown `quay` in the top right
* Click `Account Settings`
* `Generate Encrypted Password`
* Enter your password `openshift` -> Click `verify`
* Click `Docker Login` on the left
* Copy the the `docker login -u...` contents on the right by clicking the `Copy to Clipboard` icon

Back on the terminal:
* Paste in your login command (ctrl+shift+v)
* Replace the word `docker` with `skopeo`
* Append this flag to the end of your command `--tls-verify=false` (we're doing this bc of self signed certs on the Quay route)
* Press enter, you should see the following: `Login Succeeded!`

## Pull an image from Quay

* From the Quay dashboard, click on the `test` repository
* Click the `tags` icon
* Under the text `Pull this container with the following Docker command:`, click the copy button
* You've copied the docker pull command to the clipboard

From within the terminal tab to the right of your dashboard:
* Paste in the contents of the clipboard, for example:

 `docker pull quayecosystem-quay-quay.apps.cluster-1c69.1c69.example.opentlc.com/user1/test`

Replace `docker pull ` with `IMAGE_URL=`, we'll be using `Skopeo` instead. For now we just want to store the image URL in an environment variable for ease of use later. The end result should look something like this:
`IMAGE_URL=quayecosystem-quay-quay.apps.cluster-1c69.1c69.example.opentlc.com/user1/test`


Check that we've actually stored that variable!:
```execute
echo $IMAGE_URL
```
Your result should be similar to the example above. If not, repeat the previous steps.

Back to the terminal, using the URL to the image you've stored as `$IMAGE_URL` from above, lets use skopeo to move a copy of something from Quay.io over to your local instance of Quay on OpenShift.

```execute
skopeo copy --dest-tls-verify=false docker://hello-word docker://$IMAGE_URL:latest
```

 * Append the following tls flag to the end of the command before pressing enter : `--tls-verify=false`
 
 *This is necessary because we're using a non-trusted CA to sign the certificate that fronts this lab instance of Quay*

 * Press enter, and you should see your container tooling begin to download this image

## Verify 
To verify your image is now stored locally, run the following from a command prompt:
```
docker images | grep centos-mirror
```
The response should look something like this:
```
quay.apps.cluster-c2bmc-1d4d.c2bmc-1d4d.example.opentlc.com/user1/centos-mirror             8.2.2004                        831691599b88   2 weeks ago     223 MB
```

## Push the image into another repo on Quay
To come full circle here, we're going to take the centos image you just pulled down in the steps above and push it into the `user1/test` repo. Remember, we did not set this repo's state to `mirror`, so Quay will allow us to push images into it from a client.

* From the Quay dashboard, click the `test` repo
* From the pull command helper, copy everything after `docker pull` to the clipboard, so that we have the FQDN of the image. This will be our image `destination`
* Switch back to terminal
* Paste your clipboard contents into the terminal
* From your terminal history, copy the value we found earlier using the `docker images | grep centos-mirror` command. It should look something like this: `quay.apps.cluster-c2bmc-1d4d.c2bmc-1d4d.example.opentlc.com/user1/centos-mirror`. This is our image `source`.

### Tag the source image to it's new destination
* Using the values captured above, type the command below in your terminal, replacing the values with your own:
```
docker tag <source> <destination>
```
Example (notice the TAG appended to the source and destination image FQDN, you'll get this from your `docker images` command): 
```
docker tag quay.apps.cluster-c2bmc-1d4d.c2bmc-1d4d.example.opentlc.com/user1/centos-mirror:8.2.2004 quay.apps.cluster-c2bmc-1d4d.c2bmc-1d4d.example.opentlc.com/user1/test:8.2.2004

```

### Login to Quay with your container CLI

In order to push images into an image repository hosted on Quay, you must be authenticated as a user who has `Write` or `Admin` permissions to your target repo. You can verify what permissions a given user has in the settings tab of a given repository.

To login, you can use any standard image management client: IE Podman, Skopeo, docker.

Because the instance of Quay being used in this lab is temporary, we've used a self-signed TLS cert to secure the end point. By default, these are not trusted by image management tools. In order to login or push an image, you'll normall have to explicitly tell your tooling that you trust this registry.

Last note, rather than have you type your password into a terminal that is capturing your command history, Quay can generate a temporary encrypted version of your password that's time boxed and safer to use rather than a clear text version. We'll be using this to login to Quay in the steps below.

* From the Red Hat Quay dashboard, click your username dropdown in the top right of the UI, and select `Account Settings`.
* Click the gear icon on the left for the settings page.
* Under `Docker CLI Password`, click `Generate Encrypted Password`
* Enter your password `openshift`
* Click `Docker Login` on the left
* Copy the command shown to the clipboard
* Paste this command in your terminal

 ## Optionally, Tag an image as latest
The Quay UI offers a trivial way (aside from just CLI tagging) to change image tags. For example, we'll assign the tag `latest` to an image in the `test` repo.

* From the Quay dashboard, click `test`
* Click the `tags` icon
* Click 
